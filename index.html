<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Premium Gauge</title>
  <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Bebas+Neue&family=DM+Sans:wght@300;400;500;600&family=Space+Grotesk:wght@400;500;600&display=swap" rel="stylesheet">
  <script src="https://tableau.github.io/extensions-api/lib/tableau.extensions.1.latest.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      /* Theme colors - customizable */
      --bg-primary: #0a0a0f;
      --bg-secondary: #12121a;
      --bg-card: rgba(255, 255, 255, 0.03);
      --border-color: rgba(255, 255, 255, 0.08);
      --text-primary: #ffffff;
      --text-secondary: rgba(255, 255, 255, 0.6);
      
      /* Gauge colors - customizable */
      --gauge-zone-1: #f72585;
      --gauge-zone-2: #f4d03f;
      --gauge-zone-3: #00f5d4;
      --gauge-glow: rgba(201, 162, 39, 0.4);
      
      /* Accent */
      --accent-gold: #c9a227;
      --accent-highlight: #f4d03f;
    }

    body {
      font-family: 'DM Sans', sans-serif;
      background: var(--bg-primary);
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      overflow: hidden;
      position: relative;
      transition: all 0.4s ease;
    }

    /* Ambient effects */
    body::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(ellipse at 20% 20%, color-mix(in srgb, var(--gauge-zone-3) 8%, transparent) 0%, transparent 50%),
        radial-gradient(ellipse at 80% 80%, color-mix(in srgb, var(--gauge-zone-1) 6%, transparent) 0%, transparent 50%),
        radial-gradient(ellipse at 50% 50%, color-mix(in srgb, var(--gauge-zone-2) 4%, transparent) 0%, transparent 60%);
      animation: ambientMove 20s ease-in-out infinite;
      pointer-events: none;
    }

    @keyframes ambientMove {
      0%, 100% { transform: translate(0, 0) rotate(0deg); }
      33% { transform: translate(2%, -2%) rotate(1deg); }
      66% { transform: translate(-1%, 1%) rotate(-1deg); }
    }

    /* Noise texture */
    body::after {
      content: '';
      position: absolute;
      inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.9' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
      opacity: 0.03;
      pointer-events: none;
    }

    /* Theme variations */
    body.theme-light {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-card: rgba(0, 0, 0, 0.02);
      --border-color: rgba(0, 0, 0, 0.08);
      --text-primary: #1a1a2e;
      --text-secondary: rgba(26, 26, 46, 0.6);
    }

    body.theme-light::before,
    body.theme-light::after {
      opacity: 0.02;
    }

    body.theme-transparent {
      background: transparent;
    }

    body.theme-transparent::before,
    body.theme-transparent::after {
      display: none;
    }

    body.theme-transparent .gauge-card {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(20px);
    }

    /* Preset themes */
    body.preset-midnight {
      --bg-primary: #0f0f1a;
      --gauge-zone-1: #ff006e;
      --gauge-zone-2: #8338ec;
      --gauge-zone-3: #3a86ff;
      --accent-gold: #8338ec;
    }

    body.preset-forest {
      --bg-primary: #0a1f0a;
      --gauge-zone-1: #d62828;
      --gauge-zone-2: #f77f00;
      --gauge-zone-3: #2a9d8f;
      --accent-gold: #2a9d8f;
    }

    body.preset-ocean {
      --bg-primary: #0a1628;
      --gauge-zone-1: #e63946;
      --gauge-zone-2: #f4a261;
      --gauge-zone-3: #2ec4b6;
      --accent-gold: #2ec4b6;
    }

    body.preset-sunset {
      --bg-primary: #1a0a0f;
      --gauge-zone-1: #9d0208;
      --gauge-zone-2: #f48c06;
      --gauge-zone-3: #ffba08;
      --accent-gold: #f48c06;
    }

    body.preset-corporate {
      --bg-primary: #1e2a3a;
      --gauge-zone-1: #dc3545;
      --gauge-zone-2: #ffc107;
      --gauge-zone-3: #28a745;
      --accent-gold: #007bff;
    }

    body.preset-minimal {
      --bg-primary: #ffffff;
      --bg-card: rgba(0, 0, 0, 0.02);
      --border-color: rgba(0, 0, 0, 0.1);
      --text-primary: #333333;
      --text-secondary: #666666;
      --gauge-zone-1: #e74c3c;
      --gauge-zone-2: #f39c12;
      --gauge-zone-3: #27ae60;
      --accent-gold: #3498db;
    }

    body.preset-minimal::before,
    body.preset-minimal::after {
      display: none;
    }

    .gauge-container {
      position: relative;
      z-index: 1;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 40px;
    }

    .gauge-wrapper {
      position: relative;
      width: 380px;
      height: 280px;
    }

    .gauge-card {
      position: absolute;
      inset: -30px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 32px;
      backdrop-filter: blur(20px);
      box-shadow: 
        0 0 0 1px rgba(255, 255, 255, 0.02) inset,
        0 40px 80px -20px rgba(0, 0, 0, 0.5),
        0 0 120px -60px var(--gauge-glow);
      transition: all 0.4s ease;
    }

    .gauge-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 50%;
      transform: translateX(-50%);
      width: 60%;
      height: 1px;
      background: linear-gradient(90deg, transparent, var(--accent-gold), transparent);
    }

    .gauge-svg {
      position: relative;
      z-index: 2;
      filter: drop-shadow(0 20px 40px rgba(0, 0, 0, 0.4));
    }

    .arc-bg {
      fill: none;
      stroke: var(--border-color);
      stroke-width: 28;
      stroke-linecap: round;
    }

    .arc-track {
      fill: none;
      stroke: url(#arcGradient);
      stroke-width: 28;
      stroke-linecap: round;
      filter: drop-shadow(0 0 20px var(--gauge-glow));
      transition: stroke-dashoffset 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .arc-glow {
      fill: none;
      stroke: url(#arcGradient);
      stroke-width: 32;
      stroke-linecap: round;
      opacity: 0.3;
      filter: blur(8px);
    }

    .tick {
      stroke: var(--border-color);
      stroke-width: 2;
      stroke-linecap: round;
      transition: stroke 0.3s;
    }

    .tick-major {
      stroke: var(--text-secondary);
      stroke-width: 2.5;
    }

    .tick-label {
      fill: var(--text-secondary);
      font-family: 'Space Grotesk', sans-serif;
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 0.5px;
      transition: fill 0.3s;
    }

    .needle-group {
      transform-origin: 190px 190px;
      transition: transform 1.5s cubic-bezier(0.34, 1.56, 0.64, 1);
    }

    .needle {
      fill: url(#needleGradient);
      filter: drop-shadow(2px 4px 8px rgba(0, 0, 0, 0.5));
    }

    .needle-center {
      fill: url(#centerGradient);
      filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.4));
    }

    .needle-center-inner {
      fill: var(--bg-primary);
      transition: fill 0.3s;
    }

    .needle-center-dot {
      fill: var(--accent-gold);
      filter: drop-shadow(0 0 6px var(--accent-gold));
    }

    .value-container {
      position: absolute;
      bottom: 40px;
      left: 50%;
      transform: translateX(-50%);
      text-align: center;
      z-index: 3;
    }

    .value-number {
      font-family: 'Bebas Neue', sans-serif;
      font-size: 72px;
      font-weight: 400;
      letter-spacing: 2px;
      color: var(--text-primary);
      line-height: 1;
      transition: color 0.3s;
    }

    .value-unit {
      font-family: 'DM Sans', sans-serif;
      font-size: 14px;
      font-weight: 400;
      color: var(--text-secondary);
      letter-spacing: 3px;
      text-transform: uppercase;
      margin-top: 4px;
      transition: color 0.3s;
    }

    .gauge-title {
      font-family: 'Playfair Display', serif;
      font-size: 14px;
      font-weight: 600;
      letter-spacing: 3px;
      text-transform: uppercase;
      color: var(--text-secondary);
      margin-bottom: 36px;
      position: relative;
      z-index: 3;
      transition: color 0.3s;
    }

    .gauge-title::before,
    .gauge-title::after {
      content: '◆';
      font-size: 6px;
      vertical-align: middle;
      margin: 0 12px;
      color: var(--accent-gold);
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 8px 20px;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
      border-radius: 100px;
      margin-top: 40px;
      position: relative;
      z-index: 3;
      transition: all 0.3s;
    }

    .status-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--gauge-zone-3);
      box-shadow: 0 0 12px var(--gauge-zone-3);
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.warning {
      background: var(--gauge-zone-2);
      box-shadow: 0 0 12px var(--gauge-zone-2);
    }

    .status-dot.danger {
      background: var(--gauge-zone-1);
      box-shadow: 0 0 12px var(--gauge-zone-1);
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(0.85); }
    }

    .status-text {
      font-size: 11px;
      font-weight: 500;
      letter-spacing: 2px;
      text-transform: uppercase;
      color: var(--text-secondary);
    }

    .deco-ring {
      fill: none;
      stroke: var(--border-color);
      stroke-width: 1;
      opacity: 0.5;
    }

    .loading-overlay {
      position: absolute;
      inset: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      z-index: 100;
      opacity: 1;
      transition: opacity 0.5s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      pointer-events: none;
    }

    .loading-spinner {
      width: 40px;
      height: 40px;
      border: 2px solid var(--border-color);
      border-top-color: var(--accent-gold);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* Setup prompt */
    .setup-prompt {
      position: absolute;
      inset: 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      background: var(--bg-primary);
      z-index: 50;
      text-align: center;
      padding: 40px;
    }

    .setup-prompt.hidden {
      display: none;
    }

    .setup-prompt h2 {
      font-family: 'Playfair Display', serif;
      font-size: 28px;
      color: var(--text-primary);
      margin-bottom: 12px;
    }

    .setup-prompt p {
      color: var(--text-secondary);
      margin-bottom: 24px;
      font-size: 14px;
    }

    .setup-prompt button {
      padding: 14px 36px;
      background: var(--accent-gold);
      color: var(--bg-primary);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .setup-prompt button:hover {
      background: var(--accent-highlight);
      transform: translateY(-2px);
    }
  </style>
</head>
<body>
  <div class="loading-overlay" id="loadingOverlay">
    <div class="loading-spinner"></div>
  </div>

  <div class="setup-prompt" id="setupPrompt">
    <h2>⚡ Premium Gauge</h2>
    <p>Configurá la fuente de datos y el estilo visual</p>
    <button onclick="openConfigure()">Configurar</button>
  </div>

  <div class="gauge-container" id="gaugeContainer" style="display: none;">
    <div class="gauge-title" id="gaugeTitle">Performance Index</div>
    
    <div class="gauge-wrapper">
      <div class="gauge-card"></div>
      
      <svg class="gauge-svg" width="380" height="260" viewBox="0 0 380 260">
        <defs>
          <linearGradient id="arcGradient" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" id="gradStop1" style="stop-color: var(--gauge-zone-1)" />
            <stop offset="50%" id="gradStop2" style="stop-color: var(--gauge-zone-2)" />
            <stop offset="100%" id="gradStop3" style="stop-color: var(--gauge-zone-3)" />
          </linearGradient>

          <linearGradient id="needleGradient" x1="0%" y1="0%" x2="0%" y2="100%">
            <stop offset="0%" style="stop-color: #ffffff" />
            <stop offset="50%" style="stop-color: #e8e8e8" />
            <stop offset="100%" style="stop-color: #c0c0c0" />
          </linearGradient>

          <radialGradient id="centerGradient" cx="50%" cy="30%" r="60%">
            <stop offset="0%" style="stop-color: #3a3a4a" />
            <stop offset="100%" style="stop-color: #1a1a24" />
          </radialGradient>
        </defs>

        <circle class="deco-ring" cx="190" cy="190" r="175" />
        <circle class="deco-ring" cx="190" cy="190" r="178" />

        <path class="arc-bg" id="arcBg" />
        <path class="arc-glow" id="arcGlow" />
        <path class="arc-track" id="arcTrack" />

        <g id="tickMarks"></g>

        <g class="needle-group" id="needleGroup">
          <polygon class="needle" points="190,60 194,180 190,190 186,180" opacity="0.3" transform="translate(3, 3)" />
          <polygon class="needle" points="190,60 194,180 190,190 186,180" />
          <circle cx="190" cy="65" r="3" fill="#ffffff" opacity="0.8" />
        </g>

        <circle class="needle-center" cx="190" cy="190" r="24" />
        <circle class="needle-center-inner" cx="190" cy="190" r="16" />
        <circle class="needle-center-dot" cx="190" cy="190" r="4" />
      </svg>

      <div class="value-container">
        <div class="value-number" id="valueDisplay">0</div>
        <div class="value-unit" id="valueUnit">percent</div>
      </div>
    </div>

    <div class="status-badge">
      <div class="status-dot" id="statusDot"></div>
      <span class="status-text" id="statusText">On Target</span>
    </div>
  </div>

  <script>
    var config = {
      minValue: 0,
      maxValue: 100,
      currentValue: 0,
      title: 'Performance Index',
      unit: 'percent',
      startAngle: -135,
      endAngle: 135,
      radius: 140,
      centerX: 190,
      centerY: 190,
      zones: [
        { min: 0, max: 30, status: 'Crítico', color: 'danger' },
        { min: 30, max: 70, status: 'Moderado', color: 'warning' },
        { min: 70, max: 100, status: 'Excelente', color: 'good' }
      ],
      worksheetIndex: null,
      fieldName: null,
      theme: 'dark',
      preset: null
    };

    function toRadians(degrees) {
      return degrees * (Math.PI / 180);
    }

    function polarToCartesian(cx, cy, radius, angleInDegrees) {
      var angleInRadians = toRadians(angleInDegrees - 90);
      return {
        x: cx + (radius * Math.cos(angleInRadians)),
        y: cy + (radius * Math.sin(angleInRadians))
      };
    }

    function describeArc(cx, cy, radius, startAngle, endAngle) {
      var start = polarToCartesian(cx, cy, radius, endAngle);
      var end = polarToCartesian(cx, cy, radius, startAngle);
      var largeArcFlag = endAngle - startAngle <= 180 ? "0" : "1";
      return [
        "M", start.x, start.y,
        "A", radius, radius, 0, largeArcFlag, 0, end.x, end.y
      ].join(" ");
    }

    function initArcs() {
      var arcPath = describeArc(config.centerX, config.centerY, config.radius, config.startAngle, config.endAngle);
      
      document.getElementById('arcBg').setAttribute('d', arcPath);
      document.getElementById('arcGlow').setAttribute('d', arcPath);
      document.getElementById('arcTrack').setAttribute('d', arcPath);

      var arcLength = (Math.abs(config.endAngle - config.startAngle) / 360) * (2 * Math.PI * config.radius);
      var arcTrack = document.getElementById('arcTrack');
      arcTrack.style.strokeDasharray = arcLength;
      arcTrack.style.strokeDashoffset = arcLength;
    }

    function generateTicks() {
      var tickGroup = document.getElementById('tickMarks');
      tickGroup.innerHTML = '';
      
      var numMajorTicks = 5;
      var numMinorTicks = 4;
      var angleRange = config.endAngle - config.startAngle;
      
      for (var i = 0; i <= numMajorTicks; i++) {
        var percent = i / numMajorTicks;
        var angle = config.startAngle + (percent * angleRange);
        var value = config.minValue + (percent * (config.maxValue - config.minValue));
        
        var innerPoint = polarToCartesian(config.centerX, config.centerY, config.radius - 35, angle);
        var outerPoint = polarToCartesian(config.centerX, config.centerY, config.radius - 20, angle);
        
        var tick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
        tick.setAttribute('x1', innerPoint.x);
        tick.setAttribute('y1', innerPoint.y);
        tick.setAttribute('x2', outerPoint.x);
        tick.setAttribute('y2', outerPoint.y);
        tick.setAttribute('class', 'tick tick-major');
        tickGroup.appendChild(tick);
        
        var labelPoint = polarToCartesian(config.centerX, config.centerY, config.radius - 50, angle);
        var label = document.createElementNS('http://www.w3.org/2000/svg', 'text');
        label.setAttribute('x', labelPoint.x);
        label.setAttribute('y', labelPoint.y);
        label.setAttribute('class', 'tick-label');
        label.setAttribute('text-anchor', 'middle');
        label.setAttribute('dominant-baseline', 'middle');
        label.textContent = Math.round(value);
        tickGroup.appendChild(label);
        
        if (i < numMajorTicks) {
          for (var j = 1; j <= numMinorTicks; j++) {
            var minorPercent = percent + (j / (numMinorTicks + 1)) / numMajorTicks;
            var minorAngle = config.startAngle + (minorPercent * angleRange);
            
            var minorInner = polarToCartesian(config.centerX, config.centerY, config.radius - 30, minorAngle);
            var minorOuter = polarToCartesian(config.centerX, config.centerY, config.radius - 20, minorAngle);
            
            var minorTick = document.createElementNS('http://www.w3.org/2000/svg', 'line');
            minorTick.setAttribute('x1', minorInner.x);
            minorTick.setAttribute('y1', minorInner.y);
            minorTick.setAttribute('x2', minorOuter.x);
            minorTick.setAttribute('y2', minorOuter.y);
            minorTick.setAttribute('class', 'tick');
            tickGroup.appendChild(minorTick);
          }
        }
      }
    }

    function updateGauge(value, animate) {
      if (animate === undefined) animate = true;
      
      value = Math.max(config.minValue, Math.min(config.maxValue, value));
      config.currentValue = value;
      
      var percent = (value - config.minValue) / (config.maxValue - config.minValue);
      var needleAngle = config.startAngle + (percent * (config.endAngle - config.startAngle));
      
      var needleGroup = document.getElementById('needleGroup');
      needleGroup.style.transform = 'rotate(' + needleAngle + 'deg)';
      
      var arcLength = (Math.abs(config.endAngle - config.startAngle) / 360) * (2 * Math.PI * config.radius);
      var dashOffset = arcLength * (1 - percent);
      document.getElementById('arcTrack').style.strokeDashoffset = dashOffset;
      
      var valueDisplay = document.getElementById('valueDisplay');
      if (animate) {
        animateValue(valueDisplay, parseInt(valueDisplay.textContent) || 0, Math.round(value), 1500);
      } else {
        valueDisplay.textContent = Math.round(value);
      }
      
      updateStatus(value);
    }

    function updateStatus(value) {
      var zone = null;
      for (var i = 0; i < config.zones.length; i++) {
        if (value >= config.zones[i].min && value <= config.zones[i].max) {
          zone = config.zones[i];
          break;
        }
      }
      if (!zone) zone = config.zones[config.zones.length - 1];
      
      var statusDot = document.getElementById('statusDot');
      var statusText = document.getElementById('statusText');
      
      statusDot.className = 'status-dot';
      if (zone.color === 'danger') statusDot.classList.add('danger');
      else if (zone.color === 'warning') statusDot.classList.add('warning');
      
      statusText.textContent = zone.status;
    }

    function animateValue(element, start, end, duration) {
      var startTime = performance.now();
      
      function update(currentTime) {
        var elapsed = currentTime - startTime;
        var progress = Math.min(elapsed / duration, 1);
        var easeOut = 1 - Math.pow(1 - progress, 3);
        var current = Math.round(start + (end - start) * easeOut);
        
        element.textContent = current;
        
        if (progress < 1) {
          requestAnimationFrame(update);
        }
      }
      
      requestAnimationFrame(update);
    }

    function updateTitle(title) {
      document.getElementById('gaugeTitle').textContent = title;
      config.title = title;
    }

    function updateUnit(unit) {
      document.getElementById('valueUnit').textContent = unit;
      config.unit = unit;
    }

    function applyTheme(theme) {
      document.body.classList.remove('theme-light', 'theme-transparent');
      if (theme === 'light') {
        document.body.classList.add('theme-light');
      } else if (theme === 'transparent') {
        document.body.classList.add('theme-transparent');
      }
      config.theme = theme;
    }

    function applyPreset(preset) {
      // Remove all preset classes
      document.body.classList.remove(
        'preset-midnight', 'preset-forest', 'preset-ocean', 
        'preset-sunset', 'preset-corporate', 'preset-minimal'
      );
      
      if (preset && preset !== 'default') {
        document.body.classList.add('preset-' + preset);
      }
      config.preset = preset;
    }

    function applyCustomColors(zone1, zone2, zone3) {
      document.documentElement.style.setProperty('--gauge-zone-1', zone1);
      document.documentElement.style.setProperty('--gauge-zone-2', zone2);
      document.documentElement.style.setProperty('--gauge-zone-3', zone3);
    }

function openConfigure() {
  var configUrl = window.location.origin + '/configure' + window.location.search;
  alert('Abriendo: ' + configUrl);
  
  tableau.extensions.ui.displayDialogAsync(configUrl, '', { width: 450, height: 700 }).then(function(result) {
    alert('Resultado: ' + result);
    if (result === 'saved') {
      loadSettings();
      loadData();
    }
  }).catch(function(err) {
    alert('Error: ' + err.message);
  });
}

    function loadSettings() {
      var settings = tableau.extensions.settings.getAll();
      
      // Theme
      if (settings.theme) {
        applyTheme(settings.theme);
      }
      
      // Preset
      if (settings.preset) {
        applyPreset(settings.preset);
      }
      
      // Custom colors
      if (settings.colorZone1) {
        applyCustomColors(settings.colorZone1, settings.colorZone2, settings.colorZone3);
      }
      
      // Title & Unit
      if (settings.title) {
        updateTitle(settings.title);
      }
      
      if (settings.unit) {
        updateUnit(settings.unit);
      }
      
      // Ranges
      if (settings.minValue) {
        config.minValue = parseFloat(settings.minValue);
      }
      
      if (settings.maxValue) {
        config.maxValue = parseFloat(settings.maxValue);
      }
      
      // Zones
      if (settings.zoneRed && settings.zoneYellow) {
        var zoneRed = parseFloat(settings.zoneRed);
        var zoneYellow = parseFloat(settings.zoneYellow);
        
        config.zones = [
          { min: config.minValue, max: zoneRed, status: settings.labelZone1 || 'Crítico', color: 'danger' },
          { min: zoneRed, max: zoneYellow, status: settings.labelZone2 || 'Moderado', color: 'warning' },
          { min: zoneYellow, max: config.maxValue, status: settings.labelZone3 || 'Excelente', color: 'good' }
        ];
      }
      
      // Data source
      if (settings.worksheet !== undefined && settings.worksheet !== '') {
        config.worksheetIndex = parseInt(settings.worksheet);
      }
      
      if (settings.field) {
        config.fieldName = settings.field;
      }
      
      generateTicks();
    }

function loadData() {
  var dashboard = tableau.extensions.dashboardContent.dashboard;
  
  if (dashboard.worksheets.length === 0) {
    console.log('No hay hojas en el dashboard');
    return;
  }
  
  // Tomar la primera hoja automáticamente
  var worksheet = dashboard.worksheets[0];
  console.log('Leyendo hoja: ' + worksheet.name);
  
  document.getElementById('setupPrompt').classList.add('hidden');
  document.getElementById('gaugeContainer').style.display = 'flex';
  
  worksheet.getSummaryDataAsync().then(function(dataTable) {
    console.log('Filas: ' + dataTable.data.length);
    console.log('Columnas: ' + dataTable.columns.length);
    
    if (dataTable.data.length > 0) {
      // Buscar primer campo numérico
      for (var i = 0; i < dataTable.columns.length; i++) {
        var col = dataTable.columns[i];
        console.log('Columna ' + i + ': ' + col.fieldName + ' (' + col.dataType + ')');
        
        if (col.dataType === 'float' || col.dataType === 'int') {
          var value = dataTable.data[0][col.index].value;
          console.log('Valor encontrado: ' + value);
          updateGauge(value);
          return;
        }
      }
    }
  });
}

    function init() {
      initArcs();
      generateTicks();
      
      if (typeof tableau !== 'undefined' && tableau.extensions) {
        tableau.extensions.initializeAsync({ configure: openConfigure }).then(function() {
          loadSettings();
          loadData();
          
          // Escuchar cambios en filtros y selección
          var dashboard = tableau.extensions.dashboardContent.dashboard;
          dashboard.worksheets.forEach(function(worksheet) {
            worksheet.addEventListener(tableau.TableauEventType.FilterChanged, loadData);
            worksheet.addEventListener(tableau.TableauEventType.MarkSelectionChanged, loadData);
          });
          
          document.getElementById('loadingOverlay').classList.add('hidden');
        });
      } else {
        // Standalone mode
        document.getElementById('loadingOverlay').classList.add('hidden');
        document.getElementById('setupPrompt').classList.add('hidden');
        document.getElementById('gaugeContainer').style.display = 'flex';
        setTimeout(function() { updateGauge(75); }, 500);
      }
    }

    document.addEventListener('DOMContentLoaded', init);
  </script>
</body>
</html>
